<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HackAI Pong</title>
</head>
<body>
<script src="/socket.io/socket.io.js"></script>
<script>
    let socket = io.connect('localhost:3000/game');
    socket.on('force game loop', function(){
        loop();
    });

    let WIDTH = 700; // canvas width
    let HEIGHT = 600; // canvas height
    let pi = Math.PI;
    let canvas;
    let ctx; // canvas context
    let player1;
    let player2;
    let ball;
    let playerDelta = 7; // number of pixels each player can move per frame

    player1 = {
        x: null,
        y: null,
        width: 20,
        height: 100,

        update: function(direction) {
            if (direction === "up") {
                this.y = Math.max(this.y - playerDelta, 0);
            }
            else if (direction === "down") {
                this.y = Math.min(this.y + playerDelta, HEIGHT - this.height);
            }

        },
        draw: function() {
            ctx.fillRect(this.x, this.y, this.width, this.height)
        }
    };
    player2 = {
        x: null,
        y: null,
        width: 20,
        height: 100,

        update: function(direction) {
            if (ball.y + ball.side/2 < this.y + this.height/2) this.y = Math.max(this.y - playerDelta, 0);
            else if (ball.y + ball.side/2 > this.y + this.height/2) this.y = Math.min(this.y + playerDelta, HEIGHT - this.height);
            /*
            if (direction === "up") {
                this.y = Math.max(this.y - playerDelta, 0);
            }
            else if (direction === "down") {
                this.y = Math.min(this.y + playerDelta, HEIGHT - this.height);
            }
            */
        },
        draw: function() {
            ctx.fillRect(this.x, this.y, this.width, this.height)
        }
    };
    ball = {
        x: null,
        y: null,
        vel: null,
        side: 20,
        speed: 5,

        update: function() {
            this.x += this.vel.x;
            this.y += this.vel.y;

            if (this.y < 0 || this.y > HEIGHT - ball.side) {
                let offset = this.vel.y < 0 ? 0 - this.y : HEIGHT - (this.y + this.side);
                this.y += 2*offset;
                this.vel.y *= -1
            }

            // Axis-aligned bounding box intersect
            //let AABBIntersect
        },
        draw: function() {
            ctx.fillRect(this.x, this.y, this.side, this.side)
        }
    };

    function main() {
        canvas = document.createElement("canvas");
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        ctx = canvas.getContext("2d");
        document.body.appendChild(canvas);

        init();
        window.requestAnimationFrame(loop, canvas);
    }

    function loop() {
        update();
        draw();

        socket.emit('request moves', {x: ball.x, y: ball.y}, function(dirP1){
            player1.update(dirP1);

            window.requestAnimationFrame(loop, canvas);
        });
    }

    function init() {
        player1.x = player1.width;
        player1.y = (HEIGHT - player1.height) / 2;

        player2.x = WIDTH - (player1.width + player2.width);
        player2.y = (HEIGHT - player2.height) / 2;

        ball.x = (WIDTH - ball.side) / 2;
        ball.y = (HEIGHT - ball.side) / 2;

        ball.vel = {
            x: 0,
            y: ball.speed
        }
    }

    function update() {
        ball.update();
        player1.update();
        player2.update();
    }

    function draw() {
        ctx.fillRect(0, 0, WIDTH, HEIGHT);
        ctx.save();
        ctx.fillStyle = "#fff";

        ball.draw();
        player1.draw();
        player2.draw();

        var w = 4;
        var x = (WIDTH - w)*0.5;
        var y = 0;
        var step = HEIGHT/20;
        while (y < HEIGHT) {
            ctx.fillRect(x, y+step*0.25, w, step*0.5);
            y += step;
        }

        ctx.restore();
    }

    main();
</script>
</body>
</html>